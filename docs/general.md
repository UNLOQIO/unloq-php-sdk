UNLOQ PHP SDK - General information
===================================
- [Use cases](#use-cases)
- [Using the SDK](#using-the-sdk)
- [Implementing Auth - on short](#implementing-auth-on-short)

<a name="use-cases"></a>
## Use cases

Using our UNLOQ PHP SDK the following implementations are available:

* Identity provider 

    This case will enable you to build a passwordless system, only storing the email address of the user, and no other credentials.
    
    More details on [UNLOQ Docs](https://docs.unloq.io/use-case/identity-provider)
* Second factor

    This case will enable you to improve your current, credentials based, authentication system, with a second factor which will confirm the login. This will be done through our Mobile app with the use of either a One Time Password (OTP token) OR Push Notifications.
     
     More details on [UNLOQ Docs](https://docs.unloq.io/use-case/second-factor)
   
## Using the SDK

### Instantiate the library
Use an API KEY to initiate the SDK's UNLOQ client:

```
$unloqClient = new Unloq($unloqApiKey);
```

### Making requests

#### 1. Requests without a payload

```
$unloqClient->getFirewallRules()
```

#### 2. Requests with a payload

```
use Unloq\Api\Contracts\Approval\Authenticate;

...

$payload = new Authenticate();

$payload->setEmail($email)
     ->setMethod('UNLOQ')
     ->setIp($_SERVER['REMOTE_ADDR'])
     ->setGenerateToken(false);

$unloqClient->authenticate($payload)
```

Payloads are available within Unloq\Api\Contracts namespace and corresponding to the requests documented [here](https://docs.unloq.io/api-v1).

#### 3. Requests with pagination

```
$unloqClient->getFirewallRules($page, $limit)
```

#### 4. Responses

#### 4.1. Positive
A positive response will contain the following body:
```
{
    'httpCode' : 200,
    'responseMessage' : object,
}
```
where the object will contain the exact response from UNLOQ Api
#### 4.2. Negatives
A negative response will contain the following body:
```
{
    'httpCode' : 400,
    'responseMessage' : object,
    'errorCode' : 'APPROVAL.DENIED',
    'errorMessage' : 'The user denied the request',
}
```
The **errorCode** can be :
* 'SERVER.ERROR' generated by a bad connection to the UNLOQ Api, or by the UNLOQ Api;
* any other error code that is documented on [UNLOQ Docs](https://docs.unloq.io)

The **errorMessage** is an adjacent message to the errorCode.

In case the error occurred, comes from the UNLOQ Api, both of them will be extracted from the response. 



Please see below some general error codes that you might encounter:
- "FIREWALL.BLOCKED" the user's IP has been blocked within the firewall. This might occur for ay API requests or just Authentication, depending ;
- "FIREWALL.THROTTLE" the user has sent too many requests to the API and requires a couple of minutes before sending more requets;
- "APPROVAL.DEVICE" the user though it has an account, has no devices synchronized;
- "PUSH.UNREGISTERED" - the user's device doesn't allow Push notifications;

<a name="implementing-auth-on-short"></a>
## Implementing Auth - on short
In order to implement UNLOQ authentication within your web application, the following steps are required:
* create an account on [account.unloq.io](http://account.unloq.io/) by clicking GET STARTED
* within your newly created account, go to Applications
* create a new application by using "Web application" -> "Custom solution"
* visit the newly created application Settings area and API KEYS
* create a new API KEY and save it somewhere safe. When creating it, it will be the only time you will be albe to see it, so be sure that you save it somewhere safe.

Each new UNLOQ application will enable authentication through UNLOQ, OTP and/or EMAIL.

Below we'll discuss the general usage of **POST /authenticate** request to validate a certain user.
 
#### Using "EMAIL" authentication method.
When this method will be used, the following are required:
- enable within your UNLOQ application the Login method "E-mail login":
    - UNLOQ Account -> Application -> {Your app name} -> Settings -> Authentication.
- create a Login Widget:
    - UNLOQ Account -> Application -> {Your app name} -> Settings -> Widgets 
- configure the Widget with the login URL that will receive the token. If you use the following URL https://2fa-webapp.com/login, the login URL sent by UNLOQ through email will be https://2fa-webapp.com/login?token=fsd@342asdSAD32343ASDA .
<a name="usingthesdk"></a>
- the following authenticate request will be used:

```php
use Unloq\Api\Contracts\Approval\Authenticate;
use Unloq\Unloq;

...

$unloqClient = new Unloq(env('UNLOQ_API_KEY'));

$payload = new Authenticate();
$payload->setEmail($email)
    ->setMethod('EMAIL')
    ->setIp($_SERVER['REMOTE_ADDR']);

$unloqClient->authenticate($payload);
```
- when you receive the token on your web application, the token will have to be validate through the following request:

```php
use Unloq\Api\Contracts\Tokens\Token;
use Unloq\Unloq;

...

$token = $_GET['token'];

$payload = new Token();
$payload->setToken($token);

$validateToken = $unloqClient->token($payload);

if($validateToken->httpCode === 200){
    // TODO: start the user's session
}
```

#### Using "UNLOQ" authentication method.
When this method will be used, the following are required:
- enable within your UNLOQ application the Login method "Phone Authentication":
    - UNLOQ Account -> Application -> {Your app name} -> Settings -> Authentication.
- the email address that is used, has to be enrolled within your UNLOQ Application;
    - use the enroll() method from the SDK to enroll an email address;
    - on a positive response, you will be provided with a QR url;
    - the enrolled user, requires to :
        - download UNLOQ mobile app;
        - visit the QR url or view the image from the URL on a certain page;
        - pair the device by scanning the QR image (click the plus button within your mobile app);
- the following authenticate request will be used:

```php
use Unloq\Api\Contracts\Approval\Authenticate;
use Unloq\Unloq;

...

$unloqClient = new Unloq(env('UNLOQ_API_KEY'));

$payload = new Authenticate();
$payload->setEmail($email)
    ->setMethod('UNLOQ')
    ->setIp($_SERVER['REMOTE_ADDR']);

$unloqClient->authenticate($payload);
```
This request:
- will wait for an approval/denial from the mobile application;
- the time that it will wait for an action from the mobile device can be set in you UNLOQ application, general settings. The time can be set between 10 and 40 seconds;
- on a successful response (the user approves the request on his mobile device), you will receive an HTTP 200 OK code and you can proceed in starting the user's session;
- on an erroneous response (documented above) you are required to proceed depending on the error code:
    - "APPROVAL.DENIED" or "APPROVAL.TOKEN" when a user denies the request. In this case you will be required to repeat the authentication request, but this time provide the OTP token also. Just add to $payload ``->setToken($otpToken)`` where $otpToken is the otp token corresponding to your UNLOQ application from the mobile app.
    - "APPROVAL.TIMEOUT" when a user didn't approved the request in the timelimit set. You are required just to repeat the authentication request above.
    
Please see the above possible error codes that you might encounter. They should all be treated, especially "FIREWALL.BLOCKED" that can occur on authentication.
 
#### Using "OTP" authentication method.
When this method will be used, the following are required:
- enable within your UNLOQ application the Login method "Time based one time password":
    - UNLOQ Account -> Application -> {Your app name} -> Settings -> Authentication.
- the email address that is used, has to be enrolled within your UNLOQ Application;
    - use the enroll() method from the SDK to enroll an email address;
    - on a positive response, you will be provided with a QR url;
    - the enrolled user, requires to :
        - download UNLOQ mobile app;
        - visit the QR url or view the image from the URL on a certain page;
        - pair the device by scanning the QR image (click the plus button within your mobile app);
- the following authenticate request will be used:

```php
use Unloq\Api\Contracts\Approval\Authenticate;
use Unloq\Unloq;

...

$unloqClient = new Unloq(env('UNLOQ_API_KEY'));

$payload = new Authenticate();
$payload->setEmail($email)
    ->setMethod('OTP')
    ->setToken($otpToken)
    ->setIp($_SERVER['REMOTE_ADDR']);

$unloqClient->authenticate($payload);
```
This request:
- requires that you will send the OTP token of your UNLOQ application from the mobile app;
- if the token is not correct the error code received will be 'APPROVAL.TOKEN' and you'll need to make the request again;
    
Please see the previous described error codes as all of them should be treated;